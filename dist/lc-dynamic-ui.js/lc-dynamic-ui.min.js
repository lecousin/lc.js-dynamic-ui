lc.core.createClass("lc.dynamicui.DynamicEvent",function(t,e,n,i){var c=function(e){lc.dynamicui.evaluate("{"+n+"}",i,t,{event:e}),lc.dynamicui.needCycle()};if("function"==typeof t.addEventListener)lc.events.listen(t,e,c);else{if(!lc.core.instanceOf(t,"lc.events.Producer"))throw"Unable to listen to an event on object "+lc.core.typeOf(t);t.on(e,c)}lc.events.listen(i,"destroy",function(){"function"==typeof t.addEventListener?lc.events.unlisten(t,e,c):lc.core.instanceOf(t,"lc.events.Producer")&&t.unlisten(e,c)})},{}),lc.core.createClass("lc.dynamicui.DynamicProperty",function(e,t,n,i){this.object=e,this.propertyName=t;var c=new lc.async.Callback(this,this.update);lc.dynamicui.watch(n,i,c),lc.events.listen(i,"destroy",new lc.async.Callback(this,function(){lc.dynamicui.unwatch(n,i,c)}))},{update:function(e,t){this.object[this.propertyName]=e}}),lc.core.createClass("lc.dynamicui.elements.DynamicElement",function(e){(this.element=e)._lc_dynamicui=this,lc.events.listen(e,"destroy",new lc.async.Callback(this,this.destroyed))},{evaluate:function(){},destroyed:function(){lc.dynamicui.unregisterElement(this),this.element._lc_dynamicui=null,this.element=null}}),lc.app.onDefined("lc.dynamicui.elements.DynamicElement",function(){lc.core.extendClass("lc.dynamicui.elements.DynamicValue",lc.dynamicui.elements.DynamicElement,function(e){e.style.display="inline-block",this.expression=e.textContent,lc.html.empty(e),this.comment=document.createComment(this.expression),e.appendChild(this.comment),this.value=void 0,this.asHTML=e.hasAttribute("as-html"),lc.dynamicui.elements.DynamicElement.call(this,e),lc.dynamicui.registerElement(this,[this.expression])},{evaluate:function(){var e=lc.dynamicui.evaluate(this.expression,this.element);if(!lc.dynamicui.equals(e,this.value)){this.value=e,lc.html.removeChildrenAfter(this.comment);var t=this.value;if(void 0===t&&(t=""),null===t&&(t=""),this.asHTML){var n=document.createElement("DIV");for(n.innerHTML=t;0<n.childNodes.length;)this.element.appendChild(n.childNodes[0]);lc.html.processor.process(this.element)}else this.element.appendChild(document.createTextNode(t))}}})}),lc.app.onDefined("lc.dynamicui.elements.DynamicElement",function(){lc.core.extendClass("lc.dynamicui.elements.ForEach",lc.dynamicui.elements.DynamicElement,function(e){this.arrayExpression=e.getAttribute("array"),this.varName=e.getAttribute("var"),this.content=e.innerHTML,this.startComment=document.createComment("for each "+this.varName+" in "+this.arrayExpression),this.endComment=document.createComment("end for each "+this.varName+" in "+this.arrayExpression),e.parentNode.insertBefore(this.startComment,e),e.parentNode.insertBefore(this.endComment,e),lc.html.remove(e),lc.dynamicui.elements.DynamicElement.call(this,this.startComment),this.arrayValue=void 0,this.arrayElements=[],lc.dynamicui.registerElement(this,[this.arrayExpression])},{evaluate:function(){var e=lc.dynamicui.evaluate(this.arrayExpression,this.element);if(!lc.dynamicui.equals(e,this.arrayValue)){var t=[];if(e&&0<e.length)for(var n=0;n<e.length;++n){for(var i=e[n],c=!1,a=0;a<this.arrayElements.length;++a)if(lc.dynamicui.equals(i,this.arrayElements[a].value)){t.push(this.arrayElements[a]),this.arrayElements.splice(a,1),c=!0;break}c||t.push(this.createElement(i,n))}for(n=0;n<this.arrayElements.length;++n)lc.html.remove(this.arrayElements[n].element);this.arrayElements=t,this.arrayValue=e;for(n=0;n<this.arrayElements.length;++n){var l=this.arrayElements[n].element.parentNode;this.startComment.parentNode.insertBefore(this.arrayElements[n].element,this.endComment),l||lc.html.processor.process(this.arrayElements[n].element)}}},createElement:function(e,t){var n=document.createElement("DIV"),i=lc.Context.get(n);return i.addProperty(this.varName,e),i.addProperty(this.varName+"Index",t),n.innerHTML=this.content,{element:n,value:e}}})}),lc.app.onDefined(["lc.html.processor","lc.Context"],function(){lc.core.namespace("lc.dynamicui",{registerElement:function(e,t){e._watch_callback=function(){lc.dynamicui.updateElement(e)},e._watch_expressions=t;for(var n=0;n<t.length;++n)lc.dynamicui.watch(t[n],e.element,e._watch_callback)},unregisterElement:function(e){for(var t=0;t<e._watch_expressions.length;++t)lc.dynamicui.unwatch(e._watch_expressions[t],e.element,e._watch_callback)},updateElement:function(e){e.evaluate()},_watchers:[],watch:function(e,t,n){var i={expression:e,element:t,callback:n,value:void 0,check:function(){var e=lc.dynamicui.evaluate(this.expression,this.element);if(lc.dynamicui.equals(e,this.value))return!1;var t=this.value;return this.value=e,lc.async.Callback.callListeners(this.callback,[e,t]),!0}};lc.dynamicui._watchers.push(i),i.check()},unwatch:function(e,t,n){for(var i=0;i<lc.dynamicui._watchers.length;++i){var c=lc.dynamicui._watchers[i];if(c.expression===e&&c.element===t&&c.callback==c.callback){lc.dynamicui._watchers.splice(i,1);break}}},_needCycle:!1,_nextCycle:null,needCycle:function(){lc.dynamicui._needCycle||(lc.dynamicui._needCycle=!0,lc.dynamicui._nextCycle||(lc.dynamicui._nextCycle=setTimeout(function(){lc.dynamicui._cycle()},0)))},evaluate:function(t,e,n,i){var c,a=lc.Context.aggregate(e);if(i)for(var l in i)a[l]=i[l];for(;0<=(c=t.indexOf("$("));){var r=t.indexOf(")",c+2);if(r<0)break;t=t.substring(0,c)+'lc.Context.get(document.getElementById("'+t.substring(c+2,r)+'"), true)'+t.substring(r+1)}var s="",o=!0;for(var m in a)o?o=!1:s+=", ",s+=m;var u="(function("+s+")";for(var m in t.startsWith("{")?u+=t:u+="{return ("+t+");}",u+=").call(this,",o=!0,a)o?o=!1:u+=", ",u+="context."+m;u+=")";try{var h=new Function("context","return ("+u+")").call(n,a);return lc.log.trace("lc.dynamicui")&&lc.log.trace("lc.dynamicui","Expression "+t+" = "+h+"\r\nthis = "+n+", properties: "+s),h}catch(e){return void(lc.log.trace("lc.dynamicui")&&lc.log.trace("lc.dynamicui","Expression "+t+": "+e+"\r\nthis = "+n+", properties: "+s))}},equals:function(e,t){if(e===t)return!0;if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!=t.length)return!1;for(var n=0;n<e.length;++n)if(!lc.dynamicui.equals(e[n],t[n]))return!1;return!0}if(Array.isArray(t))return!1;if("object"!=typeof e)return!1;if("object"!=typeof t)return!1;for(var i in e){if(!t.hasOwnProperty(i))return!1;if(!lc.dynamicui.equals(e[i],t[i]))return!1}for(var i in t)if(!e.hasOwnProperty(i))return!1;return!0},_cycle:function(){var e=0;lc.log.debug("lc.dynamicui")&&lc.log.debug("lc.dynamicui","Start cycle");do{for(var t=0;t<lc.dynamicui._watchers.length;++t){lc.dynamicui._watchers[t].check()}lc.dynamicui._needCycle=!1}while(++e<100&&lc.dynamicui._needCycle);lc.dynamicui._nextCycle=null,lc.log.debug("lc.dynamicui")&&lc.log.debug("lc.dynamicui","End cycle: "+e)}}),lc.Context.globalEvents.on("changed",function(){lc.dynamicui.needCycle()}),lc.html.processor.addPreProcessor(function(e,t,n){if(1==e.nodeType){for(var i=0;i<e.attributes.length;++i){var c=e.attributes.item(i);c.name.startsWith("lc-dyn-property-")?new lc.dynamicui.DynamicProperty(e,c.name.substring(16),c.value,e):c.name.startsWith("lc-dyn-event-")&&new lc.dynamicui.DynamicEvent(e,c.name.substring(13),c.value,e)}if("LC-DYN"==e.nodeName)return new lc.dynamicui.elements.DynamicValue(e),void t.stop();if("LC-DYN-FOREACH"==e.nodeName)return new lc.dynamicui.elements.ForEach(e),void t.stop()}},5e3)});
//# sourceMappingURL=lc-dynamic-ui.min.js.map