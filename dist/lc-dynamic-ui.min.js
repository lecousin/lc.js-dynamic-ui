lc.core.createClass("lc.dynamicui.DynamicEvent",function(n,i,c,l){var e=function(e){var t=new lc.dynamicui.Expression("{"+c+"}",l,n,{event:e});try{t.evaluate(!0)}catch(e){lc.log.error("lc.dynamicui.DynamicEvent","Listener error on "+i+": "+e,e)}lc.dynamicui.needCycle()};if(lc.core.instanceOf(n,"lc.events.Producer"))return n.on(i,e),void lc.events.listen(l,"destroy",function(){n.unlisten(i,e)});if(void 0!==n.nodeType&&1==n.nodeType){var t=lc.Context.get(n,!0);if(t)for(var r in t){var a=t[r];if(lc.core.instanceOf(a,"lc.events.Producer")&&a.hasEvent(i))return a.on(i,e),void lc.events.listen(l,"destroy",function(){a.unlisten(i,e)})}}if("function"==typeof n.addEventListener)return lc.events.listen(n,i,e),void lc.events.listen(l,"destroy",function(){lc.events.unlisten(n,i,e)});throw new Error("Unable to listen to an event on object "+lc.core.typeOf(n))},{}),lc.core.createClass("lc.dynamicui.DynamicProperty",function(e,t,n,i){this.object=e,this.propertyName=t;var c=new lc.async.Callback(this,this.update),l=new lc.dynamicui.Expression(n,i);lc.dynamicui.watch(l,c),lc.events.listen(i,"destroy",new lc.async.Callback(this,function(){lc.dynamicui.unwatch(l,c)}))},{update:function(e,t){this.object[this.propertyName]=e}}),lc.app.onDefined("lc.dynamicui.elements.DynamicElement",function(){lc.core.extendClass("lc.dynamicui.elements.ApplyTemplate",lc.dynamicui.elements.DynamicElement,function(e){this.templateName=e.getAttribute("name"),this.variables=[];for(var t=0;t<e.childNodes.length;++t){var n=e.childNodes[t];1==n.nodeType&&"VARIABLE"==n.nodeName&&this.variables.push({name:n.getAttribute("name"),expression:n.textContent})}this.comment=document.createComment("lc-dyn-apply-template: "+this.templateName),e.parentNode.insertBefore(this.comment,e);var i=lc.Context.aggregate(e);if(lc.html.remove(e),void 0!==i["lc-dyn-template-"+this.templateName]){var c=i["lc-dyn-template-"+this.templateName];if(1==c.length)e=c[0].cloneNode(!0);else{e=document.createElement("DIV");for(t=0;t<c.length;++t)e.appendChild(c[t].cloneNode(!0))}lc.html.insertAfter(e,this.comment),i=lc.Context.get(e),lc.dynamicui.elements.DynamicElement.call(this,e);var l=[];for(t=0;t<this.variables.length;++t)this.variables[t].expression=new lc.dynamicui.Expression(this.variables[t].expression,e),l.push(this.variables[t].expression),i.addProperty(this.variables[t].name,void 0);lc.dynamicui.registerElement(this,l),lc.html.processor.process(e)}else lc.log.error("lc-dynamicui-apply-template","Unknown template "+this.templateName)},{evaluate:function(){for(var e=lc.Context.get(this.element),t=0;t<this.variables.length;++t){var n=this.variables[t],i=n.expression.evaluate();lc.dynamicui.equals(i,e[n.name])||(e[n.name]=i)}}})}),lc.app.onDefined("lc.dynamicui.elements.DynamicElement",function(){lc.core.extendClass("lc.dynamicui.elements.Conditional",lc.dynamicui.elements.DynamicElement,function(e){if("LC-DYN-IF"==e.nodeName)this.condition=e.getAttribute("condition"),this.content=e.innerHTML;else{if(!e.getAttribute("lc-dyn-if"))throw new Error("Unable to determine how to process if element");this.condition=e.getAttribute("lc-dyn-if"),(this.content=e).removeAttribute("lc-dyn-if")}this.startComment=document.createComment("if "+this.condition),this.endComment=document.createComment("end if "+this.condition),e.parentNode.insertBefore(this.startComment,e),e.parentNode.insertBefore(this.endComment,e),lc.html.remove(e),lc.dynamicui.elements.DynamicElement.call(this,this.startComment),this.conditionValue=void 0,this.condition=new lc.dynamicui.Expression(this.condition,this.element),this.currentElements=[],lc.dynamicui.registerElement(this,[this.condition])},{evaluate:function(){var e=this.condition.evaluate();if(void 0!==e&&(e=!!e),e!==this.conditionValue)if(this.conditionValue=e){if("string"==typeof this.content){var t=document.createElement("DIV");for(t.innerHTML=this.content;0<t.childNodes.length;)this.currentElements.push(t.removeChild(t.childNodes[0]))}else this.currentElements.push(this.content.cloneNode(!0));for(n=0;n<this.currentElements.length;++n)this.endComment.parentNode.insertBefore(this.currentElements[n],this.endComment),lc.html.processor.process(this.currentElements[n])}else{for(var n=0;n<this.currentElements.length;++n)lc.html.remove(this.currentElements[n]);this.currentElements=[]}}})}),lc.core.createClass("lc.dynamicui.DynamicData",function(e,t){this.expression=t,this.element=e,lc.events.listen(e,"processed",new lc.async.Callback(this,this._linkData))},{_linkData:function(){if("INPUT"==this.element.nodeName)return"checkbox"==this.element.type||"radio"==this.element.type?this._linkProperty(this.element,"checked"):(this._linkProperty(this.element,"value"),lc.events.listen(this.element,"keyup",lc.dynamicui.needCycle)),void lc.events.listen(this.element,"change",lc.dynamicui.needCycle);var e=lc.Context.get(this.element,!0);if(e)for(var t in e)if(lc.core.instanceOf(e[t],lc.events.Producer)&&"function"==typeof e[t].hasOwnProperty&&e[t].hasEvent("change")&&e[t].hasOwnProperty("value"))return this._linkProperty(e[t],"value"),void e[t].on("change",lc.dynamicui.needCycle);lc.log.warn("lc.dynamicui.DynamicData","Unable to find how to link data "+this.expression)},_linkProperty:function(n,i){var e,t,c=new lc.dynamicui.Expression("this."+i,this.element,n),l=new lc.dynamicui.Expression(this.expression,this.element,n),r=new lc.dynamicui.Expression(this.expression+" = this."+i,this.element,n);n[i]=l.evaluate(!1),lc.dynamicui.watch(l,t=new lc.async.Callback(this,function(e,t){n[i]=e})),lc.dynamicui.watch(c,e=new lc.async.Callback(this,function(e,t){r.evaluate(!1)})),lc.events.listen(this.element,"destroy",function(){lc.dynamicui.unwatch(c,e),lc.dynamicui.unwatch(l,t)})}}),lc.core.createClass("lc.dynamicui.elements.DynamicElement",function(e){(this.element=e)._lc_dynamicui=this,lc.events.listen(e,"destroy",new lc.async.Callback(this,this.destroyed))},{evaluate:function(){},destroyed:function(){lc.dynamicui.unregisterElement(this),this.element._lc_dynamicui=null,this.element=null}}),lc.app.onDefined("lc.dynamicui.elements.DynamicElement",function(){lc.core.extendClass("lc.dynamicui.elements.DynamicValue",lc.dynamicui.elements.DynamicElement,function(e){var t=document.createElement("SPAN");this.expression=new lc.dynamicui.Expression(e.textContent,t),e.parentNode.insertBefore(t,e),lc.html.remove(e),e=t,this.comment=document.createComment(this.expression.expression),e.appendChild(this.comment),this.value=void 0,this.asHTML=e.hasAttribute("as-html"),lc.dynamicui.elements.DynamicElement.call(this,e),lc.dynamicui.registerElement(this,[this.expression])},{evaluate:function(){var e=this.expression.evaluate();if(!lc.dynamicui.equals(e,this.value)){this.value=e,lc.html.removeChildrenAfter(this.comment);var t=this.value;if(void 0===t&&(t=""),null===t&&(t=""),this.asHTML){var n=document.createElement("DIV");for(n.innerHTML=t;0<n.childNodes.length;)this.element.appendChild(n.childNodes[0]);lc.html.processor.process(this.element)}else this.element.appendChild(document.createTextNode(t))}}})}),lc.app.onDefined("lc.dynamicui.elements.DynamicElement",function(){lc.core.extendClass("lc.dynamicui.elements.ForEach",lc.dynamicui.elements.DynamicElement,function(e){if("LC-DYN-FOREACH"==e.nodeName)this.arrayExpression=e.getAttribute("array"),this.varName=e.getAttribute("var"),this.content=e.innerHTML;else{if(!e.getAttribute("lc-dyn-foreach"))throw new Error("Unable to determine how to process foreach element");var t=e.getAttribute("lc-dyn-foreach"),n=t.indexOf(" in ");if(n<0)throw"Invalid foreach expression: "+t;this.varName=t.substring(0,n).trim(),this.arrayExpression=t.substring(n+4).trim(),(this.content=e).removeAttribute("lc-dyn-foreach")}this.startComment=document.createComment("for each "+this.varName+" in "+this.arrayExpression),this.endComment=document.createComment("end for each "+this.varName+" in "+this.arrayExpression),e.parentNode.insertBefore(this.startComment,e),e.parentNode.insertBefore(this.endComment,e),lc.html.remove(e),lc.dynamicui.elements.DynamicElement.call(this,this.startComment),this.arrayValue=void 0,this.arrayElements=[],this.arrayExpression=new lc.dynamicui.Expression(this.arrayExpression,this.element),lc.dynamicui.registerElement(this,[this.arrayExpression])},{evaluate:function(){var e=this.arrayExpression.evaluate();if(!lc.dynamicui.equals(e,this.arrayValue)){lc.log.trace("lc.dynamicui.ForEach")&&lc.log.trace("lc.dynamicui.ForEach","array changed: "+this.arrayExpression.expression);var t=[];if(e&&0<e.length)for(var n=0;n<e.length;++n){for(var i=e[n],c=!1,l=0;l<this.arrayElements.length;++l)if(lc.dynamicui.equals(i,this.arrayElements[l].value)){t.push(this.arrayElements[l]),this.arrayElements.splice(l,1),c=!0;break}c||t.push(this.createElement(i,n))}for(n=0;n<this.arrayElements.length;++n)for(l=0;l<this.arrayElements[n].elements.length;++l)lc.html.remove(this.arrayElements[n].elements[l]);this.arrayElements=t,this.arrayValue=lc.core.copyDeep(e);for(n=0;n<this.arrayElements.length;++n)for(l=0;l<this.arrayElements[n].elements.length;++l){var r=this.arrayElements[n].elements[l],a=r.parentNode;this.startComment.parentNode.insertBefore(r,this.endComment),a||lc.html.processor.process(r)}}},createElement:function(e,t){if("string"==typeof this.content){(c=document.createElement("DIV")).innerHTML=this.content;for(var n={elements:[],value:e};0<c.childNodes.length;){var i=c.removeChild(c.childNodes[0]);this._setContext(i,e,t),n.elements.push(i)}return n}var c=this.content.cloneNode(!0);return this._setContext(c,e,t),{elements:[c],value:e}},_setContext:function(e,t,n){var i=lc.Context.get(e);i.addProperty(this.varName,t),i.addProperty(this.varName+"Index",n)}})}),lc.core.createClass("lc.dynamicui.Expression",function(e,t,n,i){this.expression=e,this.element=t,this.thisObj=n,this.additions=i,this.currentValue=void 0,this.currentCycle=-1},{evaluate:function(t){if(this.currentCycle===lc.dynamicui.getCycleId())return this.currentValue;this.currentCycle=lc.dynamicui.getCycleId();try{if(this.currentValue=lc.Context.expression.evaluate(this.expression,this.element,this.thisObj,this.additions),this.currentValue&&lc.core.instanceOf(this.currentValue,lc.async.Future)){var e=this.currentValue;e.isDone()?this.currentValue=e.getResult():(this.currentValue=void 0,e.onsuccess(new lc.async.Callback(this,function(e){this.currentValue=e,lc.dynamicui.needCycle()}))),lc.log.trace("lc.dynamicui.Expression")&&lc.log.trace("lc.dynamicui.Expression",this.expression+" = "+this.currentValue+"\r\ntype = "+lc.core.typeOf(this.currentValue)+", this = "+this.thisObj+", properties: "+properties)}}catch(e){if(t)throw e;this.currentValue=void 0}return this.currentValue}}),lc.app.onDefined(["lc.html.processor","lc.Context"],function(){lc.core.namespace("lc.dynamicui",{registerElement:function(e,t){if(!e.element)throw new Error("Dynamic element must have an element attached");e._watch_callback=function(){lc.dynamicui.updateElement(e)},e._watch_expressions=t;for(var n=0;n<t.length;++n)lc.dynamicui.watch(t[n],e._watch_callback);lc.dynamicui.needCycle()},unregisterElement:function(e){for(var t=0;t<e._watch_expressions.length;++t)lc.dynamicui.unwatch(e._watch_expressions[t],e._watch_callback);lc.dynamicui._elementsToUpdate.remove(e)},_elementsToUpdate:[],updateElement:function(e){lc.dynamicui._elementsToUpdate.push(e)},_updateElements:function(){for(var e=[],t=0;t<lc.dynamicui._elementsToUpdate.length;++t){var n=lc.dynamicui._elementsToUpdate[t];if(n.element){for(var i=!1,c=0;c<e.length;++c){if(e[c]===n){i=!0;break}if(lc.xml.isAncestorOf(e[c].element,n.element)){i=!0;break}}if(!i){for(c=0;c<e.length;++c)lc.xml.isAncestorOf(n.element,e[c].element)&&(e.splice(c,1),c--);e.push(n)}}}for(t=0;t<e.length;++t)e[t].element&&lc.dynamicui._updateElementsHierarchy(e[t].element)},_updateElementsHierarchy:function(e){e._lc_dynamicui&&e._lc_dynamicui.evaluate();for(var t=0;t<e.childNodes.length;++t)lc.dynamicui._updateElementsHierarchy(e.childNodes[t])},_watchers:[],watch:function(e,t){if(!lc.core.instanceOf(e,lc.dynamicui.Expression))throw new Error("lc.dynamicui.watch must be called with a lc.dynamicui.Expression instance, given is: "+lc.core.typeOf(e));var n={expression:e,callback:t,value:void 0,check:function(){var e=this.expression.evaluate();if(lc.dynamicui.equals(e,this.value))return!1;var t=this.value;return this.value=e,lc.async.Callback.callListeners(this.callback,[e,t]),!0}};lc.dynamicui._watchers.push(n),n.check()},unwatch:function(e,t){for(var n=0;n<lc.dynamicui._watchers.length;++n){var i=lc.dynamicui._watchers[n];if(i.expression===e&&i.callback==i.callback){lc.dynamicui._watchers.splice(n,1);break}}},_needCycle:!1,_nextCycle:null,_cycleId:0,needCycle:function(){if(!lc.dynamicui._needCycle){if(lc.log.trace("lc.dynamicui"))try{throw new Error}catch(e){lc.log.trace("lc.dynamicui","needCycle here:\r\n"+e.stack)}lc.dynamicui._needCycle=!0,lc.dynamicui._nextCycle||(lc.dynamicui._nextCycle=setTimeout(function(){lc.dynamicui._cycle()},0))}},getCycleId:function(){return lc.dynamicui._cycleId},equals:function(e,t,n){if(null===e||null===t)return e===t;if(void 0===e||void 0===t)return e===t;if(n||(n=[]),n.contains(e)&&n.contains(t))return!0;if((n=n.slice()).push(e),n.push(t),Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!=t.length)return!1;for(var i=0;i<e.length;++i)if(!lc.dynamicui.equals(e[i],t[i],n))return!1;return!0}if(Array.isArray(t))return!1;if("object"!=typeof e)return"object"!=typeof t&&e===t;if("object"!=typeof t)return!1;for(var c in e){if(!t.hasOwnProperty(c))return!1;if(!lc.dynamicui.equals(e[c],t[c],n))return!1}for(var c in t)if(!e.hasOwnProperty(c))return!1;return!0},_cycle:function(){var e=0;lc.log.debug("lc.dynamicui")&&lc.log.debug("lc.dynamicui","Start cycle");var t=(new Date).getTime();do{lc.dynamicui._cycleId++,lc.dynamicui._needCycle=!1,0<e&&lc.log.debug("lc.dynamicui")&&lc.log.debug("lc.dynamicui","New cycle needed ("+e+")");for(var n=0;n<lc.dynamicui._watchers.length;++n){lc.dynamicui._watchers[n].check()}lc.dynamicui._updateElements()}while(++e<100&&lc.dynamicui._needCycle);lc.dynamicui._nextCycle=null,lc.log.debug("lc.dynamicui")&&lc.log.debug("lc.dynamicui","End cycle: "+e+" done in "+((new Date).getTime()-t)+"ms.")}}),lc.Context.globalEvents.on("changed",function(){lc.dynamicui.needCycle()}),lc.html.processor.addPreProcessor(function(e,t,n){if(1==e.nodeType){for(var i=0;i<e.attributes.length;++i){var c=e.attributes.item(i);if(c.name.startsWith("lc-dyn-property-"))new lc.dynamicui.DynamicProperty(e,c.name.substring(16),c.value,e);else if("lc-dyn-controller"==c.name){var l=c.value,r="controller",a=l.indexOf(" as ");0<a&&(r=l.substring(a+4).trim(),l=l.substring(0,a).trim());var s=lc.core.fromName(l);if(s){var o=new s(e,t);lc.Context.get(e).setProperty(r,o)}else lc.log.error("lc.dynamicui","Controller class does not exist: "+l)}else"lc-dyn-data"==c.name&&new lc.dynamicui.DynamicData(e,c.value)}if("LC-DYN"==e.nodeName)return new lc.dynamicui.elements.DynamicValue(e),void t.stop();if("LC-DYN-IF"==e.nodeName||e.getAttribute("lc-dyn-if"))return new lc.dynamicui.elements.Conditional(e),void t.stop();if("LC-DYN-FOREACH"==e.nodeName||e.getAttribute("lc-dyn-foreach"))return new lc.dynamicui.elements.ForEach(e),void t.stop();if("LC-DYN-TEMPLATE"==e.nodeName||e.getAttribute("lc-dyn-template"))return new lc.dynamicui.Template(e),void t.stop();if("LC-DYN-APPLY-TEMPLATE"==e.nodeName)return new lc.dynamicui.elements.ApplyTemplate(e),void t.stop()}},2e4),lc.html.processor.addPostProcessor(function(e,t,n){if(1==e.nodeType)for(var i=0;i<e.attributes.length;++i){var c=e.attributes.item(i);if(c.name.startsWith("lc-dyn-event-"))new lc.dynamicui.DynamicEvent(e,c.name.substring(13),c.value,e);else if("lc-dyn-event"==c.name){var l=c.nodeValue,r=l.indexOf("="),a=l.substring(r+1);r=(l=l.substring(0,r)).indexOf(" on ");var s=l.substring(0,r).trim(),o=l.substring(r+4).trim();if(!(m=lc.Context.searchValue(e,o))){lc.log.error("lc.dynamicui","lc-dyn-event: Property "+o+" not found in the context of the element");continue}var m=ctx[o];if(!lc.core.instanceOf(m,"lc.events.Producer")){lc.log.error("lc.dynamicui","lc-dyn-event: Property "+o+" is not a lc.events.Producer: "+lc.core.typeOf(m));continue}if(!m.hasEvent(s)){lc.log.error("lc.dynamicui","lc-dyn-event: Property "+o+" of type "+lc.Core.typeOf(m)+" has no event "+s);continue}new lc.dynamicui.DynamicEvent(m,s,a,e)}}},5e3),lc.app.addAsynchronousOperationListener(function(e){e.ondone(lc.dynamicui.needCycle)})}),lc.core.createClass("lc.dynamicui.Template",function(e){var t=lc.Context.get(e.parentNode);e.parentNode.removeChild(e);var n,i=[];if("LC-DYN-TEMPLATE"==e.nodeName){for(;0<e.childNodes.length;)i.push(e.childNodes[0]);n=e.getAttribute("name")}else{if(!e.getAttribute("lc-dyn-template"))throw new Error("Unable to determine how to process template element");i.push(e),n=e.getAttribute("lc-dyn-template"),e.removeAttribute("lc-dyn-template")}t.addProperty("lc-dyn-template-"+n,i)},{});
//# sourceMappingURL=lc-dynamic-ui.min.js.map